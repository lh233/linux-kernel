balance_pgdat 函数是回收页面的主函数。这个函数比较长，首先看一个框架，主体函数是一个很长的while循环，简化后的代码如下：

```
[balance_pgdat()函数总体框架]
static unsigned long balance_pgdat(pg_data_t *pgdat, int order,
							int *classzone_idx)
{
	struct scan_control sc = {
		.gfp_mask = GFP_KERNEL,
		.order = order,
		.priority = DEF_PRIORITY,
		.may_writepage = !laptop_mode,
		.may_unmap = 1,
		.may_swap = 1,
	};
	...
	do {
		//从高端zone往低端zone方向查找第一个处于不平衡的end_zone
		for (i = pgdat->nr_zones - 1; i >= 0; i--) {
			struct zone *zone = pgdat->node_zones + i;
			...
			if (!zone_balanced(zone, order, 0, 0)) {
				end_zone = i;
				break;
			}
		}
		
		//从最低端zone开始页面回收，一直到end_zone
		for (i = 0; i <= end_zone; i++) {
			struct zone *zone = pgdat->node_zones + i;
			kswapd_shrink_zone(zone, end_zone,
					       &sc, &nr_attempted);
		}
		//不断加大扫码粒度，并且检查最低端zone到classzone_idx的zone是否处于平衡状态
	}while (sc.priority >= 1 &&
		 !pgdat_balanced(pgdat, order, *classzone_idx));
}
```

